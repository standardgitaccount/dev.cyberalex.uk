<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zilchy.link – Create a new link</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Create a new Zilchy.link short URL and submit it via GitHub pull request." />
  <link rel="stylesheet" href="styles.css">
</head>
<body class="page page-center">
  <main class="shell">
    <header class="brand">
      <div class="logo-circle">Z</div>
      <div>
        <h1>Zilchy.link</h1>
        <p class="tagline">Almost no link.</p>
      </div>
    </header>

    <section class="search-area">
      <form id="createForm" autocomplete="off">
        <h2 class="result-heading" style="margin-top:0;margin-bottom:10px;">
          Create a new link
        </h2>

        <label for="longUrl" class="field-label">
          Long URL to shorten
        </label>
        <input
          id="longUrl"
          type="url"
          inputmode="url"
          spellcheck="false"
          placeholder="https://example.com/your/very/long/link"
          aria-label="Long URL to shorten"
          required
        />

        <p class="hint">
          Tip: include <code>https://</code> so your link works correctly.
        </p>

        <div class="button-row">
          <button type="submit" class="btn-primary">Generate code</button>
          <button type="button" class="btn-secondary" onclick="window.location.href='/'">
            Back to homepage
          </button>
        </div>
      </form>
    </section>

    <section id="resultPanel" class="status" hidden>
      <h2 class="result-heading">Your new Zilchy link</h2>
      <p>
        Code: <code id="codeOut"></code><br>
        Short URL: <code id="shortOut"></code>
      </p>

      <p class="hint">
        To make this live, you need to add it to <code>urls.json</code> in the Zilchy.link repository.
      </p>

      <h3 class="result-subheading">JSON entry to paste</h3>
      <p class="hint">
        Add this line inside the top-level JSON object (keep commas correct):
      </p>
      <pre id="jsonSnippet" class="snippet"></pre>

      <h3 class="result-subheading">How to create a pull request</h3>
      <ol class="steps">
        <li>
          Open the Zilchy.link GitHub repository in your browser
          (for example: <code>https://github.com/&lt;your-user&gt;/zilchy.link</code> or the main upstream repo).
        </li>
        <li>
          Click <strong>Fork</strong> to create your own copy of the repository (if you haven’t already).
        </li>
        <li>
          In your fork, open the file <code>urls.json</code> and click <strong>Edit</strong>.
        </li>
        <li>
          Insert the JSON line shown above into the object, keeping the file valid JSON
          (commas between entries, unique keys).
        </li>
        <li>
          Add a short commit message like <code>Add Zilchy code <span id="codeOutInline"></span></code> and save/commit the change.
        </li>
        <li>
          Click <strong>Compare &amp; pull request</strong>, check the diff, and submit your PR for review.
        </li>
      </ol>

      <p class="hint">
        Once the pull request is merged and the site redeploys, your Zilchy link will start working.
      </p>
    </section>

    <footer class="footer">
      <small>Want to hack on the project? Check out the repo README for contribution guidelines.</small>
    </footer>
  </main>

  <script>
    const form = document.getElementById('createForm');
    const longUrlInput = document.getElementById('longUrl');
    const resultPanel = document.getElementById('resultPanel');
    const codeOut = document.getElementById('codeOut');
    const codeOutInline = document.getElementById('codeOutInline');
    const shortOut = document.getElementById('shortOut');
    const jsonSnippet = document.getElementById('jsonSnippet');

    const alphabet = '0123456789abcdefghijklmnopqrstuvwxyz';

    function randomCode() {
      let out = '';
      for (let i = 0; i < 4; i++) {
        const idx = Math.floor(Math.random() * alphabet.length);
        out += alphabet[idx];
      }
      return out;
    }

    async function loadUrlMap() {
      const res = await fetch('urls.json', { cache: 'no-store' });
      if (!res.ok) {
        throw new Error('Could not load urls.json');
      }
      return res.json();
    }

    async function generateUniqueCode(map) {
      const maxAttempts = 10000;
      for (let i = 0; i < maxAttempts; i++) {
        const code = randomCode();
        if (!Object.prototype.hasOwnProperty.call(map, code)) {
          return code;
        }
      }
      throw new Error('Could not find a free code. Try again.');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultPanel.hidden = true;

      let url = (longUrlInput.value || '').trim();

      if (!url) {
        alert('Please enter a URL to shorten.');
        return;
      }

      if (!/^https?:\/\//i.test(url)) {
        url = 'https://' + url;
      }

      longUrlInput.value = url;

      try {
        new URL(url);
      } catch (err) {
        alert('That does not look like a valid URL. Please check and try again.');
        return;
      }

      const primaryBtn = form.querySelector('.btn-primary');
      primaryBtn.disabled = true;
      primaryBtn.textContent = 'Generating…';

      try {
        const map = await loadUrlMap();
        const code = await generateUniqueCode(map);
        const shortUrl = window.location.origin.replace(/\/+$/, '') + '/' + code;

        codeOut.textContent = code;
        codeOutInline.textContent = code;
        shortOut.textContent = shortUrl;

        const snippetLine = `"${code}": "${url}"`;
        jsonSnippet.textContent = snippetLine;

        resultPanel.hidden = false;
        resultPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (err) {
        console.error(err);
        alert('Something went wrong while generating your code. Please try again later.');
      } finally {
        primaryBtn.disabled = false;
        primaryBtn.textContent = 'Generate code';
      }
    });
  </script>
</body>
</html>
